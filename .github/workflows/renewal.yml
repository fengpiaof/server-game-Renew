name: ğŸš€ XServer æ¸¸æˆè‡ªåŠ¨ç»­æœŸ

on:
  schedule:
    - cron: "0 */6 * * *"  # æ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:
    inputs:
      force_run:
        description: 'ğŸ”„ å¼ºåˆ¶æ‰§è¡Œï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: true
        default: 'true'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  renewal:
    name: ğŸ”„ æ‰§è¡Œæ¸¸æˆæœåŠ¡å™¨ç»­æœŸä»»åŠ¡
    runs-on: ubuntu-latest

    services:
      flaresolverr:
        image: ghcr.io/flaresolverr/flaresolverr:latest
        ports:
          - 8191:8191
        env:
          LOG_LEVEL: info
          CAPTCHA_SOLVER: none

    steps:
      # ğŸ“¦ å‡†å¤‡é˜¶æ®µ
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          echo "ğŸ“¦ æ­£åœ¨å®‰è£… Python ä¾èµ–..."
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… Python ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸŒ å®‰è£… Playwright æµè§ˆå™¨
        run: |
          echo "ğŸŒ æ­£åœ¨å®‰è£… Chromium æµè§ˆå™¨..."
          playwright install chromium
          playwright install-deps chromium
          echo "âœ… æµè§ˆå™¨å®‰è£…å®Œæˆ"

      # ğŸ” æµ‹è¯• FlareSolverr è¿æ¥
      - name: ğŸ” æµ‹è¯• FlareSolverr æœåŠ¡
        run: |
          echo "ğŸ” æµ‹è¯• FlareSolverr è¿æ¥..."
          max_retries=10
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if curl -s http://localhost:8191/v1 > /dev/null; then
              echo "âœ… FlareSolverr æœåŠ¡å·²å°±ç»ª"
              curl -X POST http://localhost:8191/v1 \
                -H "Content-Type: application/json" \
                -d '{"cmd":"sessions.list"}' | python3 -m json.tool
              break
            fi
            
            retry_count=$((retry_count + 1))
            echo "â³ ç­‰å¾… FlareSolverr å¯åŠ¨... ($retry_count/$max_retries)"
            sleep 3
          done
          
          if [ $retry_count -eq $max_retries ]; then
            echo "âŒ FlareSolverr å¯åŠ¨å¤±è´¥"
            exit 1
          fi

      # ğŸš€ æ‰§è¡Œæ¸¸æˆæœåŠ¡å™¨ç»­æœŸ
      - name: ğŸ¯ è¿è¡Œç»­æœŸè„šæœ¬
        env:
          # ğŸ” è´¦å·ä¿¡æ¯
          XSERVER_EMAIL: ${{ secrets.XSERVER_EMAIL }}
          XSERVER_PASSWORD: ${{ secrets.XSERVER_PASSWORD }}
          
          # ğŸ”§ FlareSolverr é…ç½®ï¼ˆä½¿ç”¨æœ¬åœ°æœåŠ¡ï¼‰
          FLARESOLVERR_URL: 'http://localhost:8191/v1'
          
          # ğŸ¤– éªŒè¯ç è¯†åˆ« API
          CAPTCHA_API_URL: ${{ secrets.CAPTCHA_API_URL }}
          
          # ğŸ“± Telegram é€šçŸ¥
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          
          # âš™ï¸ è¿è¡Œé…ç½®
          USE_HEADLESS: 'true'   # â˜… æ”¹å› true - ä¸å†éœ€è¦ Xvfb
          WAIT_TIMEOUT: '30000'
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œ XServer æ¸¸æˆæœåŠ¡å™¨è‡ªåŠ¨ç»­æœŸä»»åŠ¡..."
          echo "â° æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ é…ç½®æ£€æŸ¥:"
          if [ -n "$XSERVER_EMAIL" ]; then echo_]()
